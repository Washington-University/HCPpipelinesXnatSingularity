Bootstrap: docker
From: centos:7.5.1804

%help
	CentOS 7.5.1804 Singularity container for StructuralPreprocessing & FunctionalPreprocessing pipelines
	
	To see what Singularity Apps are available, type:

		singularity apps HCPprocessXnatPipelines.simg
		
	For more help on a particular App, type:
	
		singularity help --app <app-name> HCPprocessXnatPipelines.simg

		where <app-name> is one of the available Apps in the container
	
%labels
	Version v1.0
	Maintainer Connectome Coordination Facility

%post
	yum -y update && yum -y upgrade
	yum install -y wget tar.x86_64 gzip zip unzip git which bzip2 bc hostname java tcsh libgomp libGLU libXmu gcc qt5-qtbase mesa-dri-drivers mesa-libGL-devel
	mkdir -p /pipeline_tools/xnat_pbs_jobs
	mkdir -p /pipeline_tools/HCPpipelinesRunUtils	
	mkdir -p /HCP/intradb/archive
	mkdir -p /HCP/hcpdb/archive
	mkdir -p /HCP/hcpdb/build_ssd
	mkdir -p /usr/local/torque-6.1.2
	
	cd /pipeline_tools
	
	####	hcp_pipelines_run_utils v1.2.0
	wget https://github.com/Washington-University/HCPpipelinesRunUtils/archive/v1.2.0.tar.gz -O hcp_pipelines_run_utils.tar.gz
	tar xvf hcp_pipelines_run_utils.tar.gz -C /pipeline_tools/HCPpipelinesRunUtils --strip-components=1
	rm hcp_pipelines_run_utils.tar.gz
	
	####	HCPpipelinesXnatPbsUtils v1.0.0	
	wget https://github.com/Washington-University/HCPpipelinesXnatPbsUtils/archive/master.tar.gz -O hcp_pipelines_xnat_pbs_utils.tar.gz
	tar xvf hcp_pipelines_xnat_pbs_utils.tar.gz -C /pipeline_tools/xnat_pbs_jobs --strip-components=1
	rm hcp_pipelines_xnat_pbs_utils.tar.gz

	#### xnat_utilities for xnat singularity
	wget https://github.com/Washington-University/xnat_utilities/archive/v1.1.0.tar.gz -O xnat_utils.tar.gz
	mkdir -p /export/HCP/xnat_utilities
	tar xvf xnat_utils.tar.gz -C /export/HCP/xnat_utilities --strip-components=1
	chmod 755 /export/HCP/xnat_utilities/xnat_access.py
	rm xnat_utils.tar.gz
	
	####	miniconda
	wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /pipeline_tools/miniconda.sh
	bash /pipeline_tools/miniconda.sh -b -p /opt/miniconda
	rm /pipeline_tools/miniconda.sh
	export PATH=/opt/miniconda/bin:${PATH}
	conda create -y --name singlepython3 python=3
	source activate singlepython3
	conda install -y requests
	conda install -y pyqt
	cd

	####	install epd-7.3.2
	wget https://www.clear.rice.edu/comp140/downloads/epd/linux/epd-7.3-2-rh5-x86_64.sh
	mkdir -p /export/HCP/epd-7.3.2
	bash epd-7.3-2-rh5-x86_64.sh -b -p /export/HCP/epd-7.3.2
	rm epd-7.3-2-rh5-x86_64.sh
	rm -rf /export/HCP/epd-7.3.2/Examples/*
	rm -rf /export/HCP/epd-7.3.2/Doc/*
	
	export PATH=/export/HCP/epd-7.3.2/bin:${PATH}
	yum install -y epel-release
	yum install -y python2-pip.noarch
	pip2 install numpy
	pip2 install nibabel==2.3.0 --install-option="--prefix=/export/HCP/epd-7.3.2"
	pip2 install requests==2.5.3 --install-option="--prefix=/export/HCP/epd-7.3.2"
	
	yum clean packages
	rm -rf /var/cache/yum/* 
			
%environment
	export PATH=/opt/miniconda/bin:/usr/local/torque-6.1.2/bin:/usr/local/torque-6.1.2/sbin:${PATH}
	source activate singlepython3
	export QT_XKB_CONFIG_ROOT=/usr/share/X11/xkb
	export HCP_RUN_UTILS=/pipeline_tools/HCPpipelinesRunUtils
	export XNAT_PBS_JOBS=/pipeline_tools/xnat_pbs_jobs
	export EPD_PYTHON_HOME=/export/HCP/epd-7.3.2
	export PATH=${EPD_PYTHON_HOME}/bin:${PATH}
	export CLUSTER="2.0"
	export PYTHONPATH=${HCP_RUN_UTILS}/lib:${XNAT_PBS_JOBS}/lib
	export XNAT_PBS_JOBS_PIPELINE_ENGINE=${XNAT_PBS_JOBS}/WorkingDirPut
	export XNAT_UTILS_HOME=/export/HCP/xnat_utilities
		
	
%apprun SubmitStructuralPreprocessingJob
	exec /pipeline_tools/xnat_pbs_jobs/StructuralPreprocessing/SubmitStructuralPreprocessingBatch "$@"
%applabels SubmitStructuralPreprocessingJob
	SubmitStructuralPreprocessingJob XNAT_RUN_JOBS
			
%apprun StructuralPreprocessingGetData
	exec /pipeline_tools/xnat_pbs_jobs/StructuralPreprocessing/StructuralPreprocessing.XNAT_GET "$@"
%applabels StructuralPreprocessingGetData
	StructuralPreprocessingGetData XNAT_GET_DATA
	
%apprun StructuralPreprocessingControl
	exec /pipeline_tools/xnat_pbs_jobs/StructuralPreprocessing/StructuralPreprocessingControl "$@"
%applabels StructuralPreprocessingControl
	StructuralPreprocessingControl XNAT_CONTROL	
	
%apprun StructuralPreprocessingMarkRunningStatus
	exec /pipeline_tools/xnat_pbs_jobs/StructuralPreprocessing/StructuralPreprocessing.XNAT_MARK_RUNNING_STATUS "$@"
%applabels StructuralPreprocessingMarkRunningStatus
	StructuralPreprocessingMarkRunningStatus XNAT_MARK_RUNNING_STATUS
	
%apprun StructuralPreprocessing
	exec /pipeline_tools/xnat_pbs_jobs/StructuralPreprocessing/StructuralPreprocessing.XNAT_PROCESS "$@"
%applabels StructuralPreprocessing
	StructuralPreprocessing XNAT_PROCESS_DATA	
	
%apprun StructuralPreprocessingCheckData
	exec /pipeline_tools/xnat_pbs_jobs/StructuralPreprocessing/StructuralPreprocessing.XNAT_CHECK "$@"
%applabels StructuralPreprocessingCheckData
	StructuralPreprocessingCheckData XNAT_CHECK_DATA
	
%apprun PutData
	exec /pipeline_tools/xnat_pbs_jobs/WorkingDirPut/XNAT_working_dir_put.sh "$@"
%applabels PutData
	PutData XNAT_PUT_DATA
		
%apprun SubmitFunctionalPreprocessingJob
	exec /pipeline_tools/xnat_pbs_jobs/FunctionalPreprocessing/SubmitFunctionalPreprocessingBatch "$@"
%applabels SubmitFunctionalPreprocessingJob
	SubmitFunctionalPreprocessingJob XNAT_RUN_JOBS
		
%apprun FunctionalPreprocessingGetData
	exec /pipeline_tools/xnat_pbs_jobs/FunctionalPreprocessing/FunctionalPreprocessing.XNAT_GET "$@"
%applabels FunctionalPreprocessingGetData
	FunctionalPreprocessingGetData XNAT_GET_DATA
	
%apprun FunctionalPreprocessingControl
	exec /pipeline_tools/xnat_pbs_jobs/FunctionalPreprocessing/FunctionalPreprocessingControl "$@"
%applabels FunctionalPreprocessingControl
	FunctionalPreprocessingControl XNAT_CONTROL	
	
%apprun FunctionalPreprocessingMarkRunningStatus
	exec /pipeline_tools/xnat_pbs_jobs/FunctionalPreprocessing/FunctionalPreprocessing.XNAT_MARK_RUNNING_STATUS "$@"
%applabels FunctionalPreprocessingMarkRunningStatus
	FunctionalPreprocessingMarkRunningStatus XNAT_MARK_RUNNING_STATUS
	
%apprun FunctionalPreprocessing
	exec /pipeline_tools/xnat_pbs_jobs/FunctionalPreprocessing/FunctionalPreprocessing.XNAT_PROCESS "$@"
%applabels FunctionalPreprocessing
	FunctionalPreprocessing XNAT_PROCESS_DATA	
	
%apprun FunctionalPreprocessingCheckData
	exec /pipeline_tools/xnat_pbs_jobs/FunctionalPreprocessing/FunctionalPreprocessing.XNAT_CHECK "$@"
%applabels FunctionalPreprocessingCheckData
	FunctionalPreprocessingCheckData XNAT_CHECK_DATA
		
